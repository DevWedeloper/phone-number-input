---
import type { Root } from '../typedoc-zod'
import type { Column, Row } from '../types/table'
import Table from '../table/Table.astro'

interface Props {
  data: Root
}

function renderType(type: any): string {
  switch (type.type) {
    case 'intrinsic':
      return type.name

    case 'reference':
      return type.name

    case 'literal':
      return JSON.stringify(type.value)

    case 'union':
      return type.types.map(renderType).join(' | ')

    case 'reflection':
      return `{ ${type.declaration.children
        .map((p: any) => {
          const optional = p.flags?.isOptional ? '?' : ''
          return `${p.name}${optional}: ${renderType(p.type)}`
        })
        .join('; ')} }`

    default:
      return 'unknown'
  }
}

const { data } = Astro.props
---

{
  data.children.length > 0 && (
    <>
      {data.children.map((typeAlias) => {
        const description = typeAlias.comment?.summary.map((s) => s.text).join('') ?? ''

        return (
          <section class="mb-10">
            {/* TYPE NAME */}
            <h3 id={typeAlias.name.toLowerCase()} class="mb-2 text-lg font-semibold">
              {typeAlias.name}
            </h3>

            {/* KIND */}
            <p class="mb-2 text-sm text-gray-500">Type alias</p>

            {/* DESCRIPTION */}
            {description && (
              <div class="mb-4 max-w-none">
                <p>{description}</p>
              </div>
            )}

            {/* UNION VARIANTS */}
            <section class="mt-6">
              <h4 class="mb-3 text-base font-semibold">Variants</h4>

              {typeAlias.type.types.map((variant, index) => {
                const columns: Column[] = [
                  { label: 'Property', key: 'name', class: 'font-medium' },
                  { label: 'Type', key: 'type' },
                  { label: 'Optional', key: 'optional' },
                ]

                const rows: Row[] = variant.declaration.children.map((prop: any) => ({
                  name: prop.name,
                  type: renderType(prop.type),
                  optional: prop.flags?.isOptional ? 'Yes' : 'No',
                }))

                return (
                  <section class="mb-6">
                    <h5 class="mb-2 text-sm font-semibold">Variant {index + 1}</h5>

                    <Table title="Properties" columns={columns} rows={rows} />
                  </section>
                )
              })}
            </section>
          </section>
        )
      })}
    </>
  )
}
